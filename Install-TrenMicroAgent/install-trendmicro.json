{
  "schemaVersion": "2.2",
  "description": "TrendMicro Install and registration",
  "mainSteps": [
    {
      "precondition": {
        "StringEquals": [
          "platformType",
          "Linux"
        ]
      },
      "action": "aws:runShellScript",
      "name": "TrendMicroInstallandRegisterLinux",
      "inputs": {
        "id": "0.aws:runShellScript",
        "timeoutSeconds": 600,
        "runCommand": [
          "sudo service ds_agent status",
          "if [[ $? = 0 ]]; then",
          "    echo \"Trend already installed\"",
          "    logger -t \"Trend already installed\"",
          "    exit 0",
          "fi",
          "ACTIVATIONURL=\"dsm://agents.deepsecurity.trendmicro.com:443/\"",
          "MANAGERURL=\"https://app.deepsecurity.trendmicro.com:443\"",
          "CURLOPTIONS=\"--silent --tlsv1.2\"",
          "linuxPlatform=\"\"",
          "isRPM=\"\"",
          "if [[ $(/usr/bin/id -u) -ne 0 ]]; then",
          "    echo \"You are not running as the root user.  Please try again with root privileges.\"",
          "    logger -t \"You are not running as the root user.  Please try again with root privileges.\"",
          "    exit 1",
          "fi;",
          "if ! type curl >/dev/null 2>&1; then",
          "    echo \"Please install CURL before running this script.\"",
          "    logger -t \"Please install CURL before running this script\"",
          "    exit 1",
          "fi",
          "CURLOUT=$(eval curl $MANAGERURL/software/deploymentscript/platform/linuxdetectscriptv1/ -o /tmp/PlatformDetection $CURLOPTIONS;)",
          "err=$?",
          "if [[ $err -eq 60 ]]; then",
          "    echo \"TLS certificate validation for the agent package download has failed.\"",
          "    logger -t \"TLS certificate validation for the agent package download has failed.\"",
          "    exit 1;",
          "fi",
          "if [ -s /tmp/PlatformDetection ]; then",
          "    . /tmp/PlatformDetection",
          "else",
          "    echo \"Failed to download the agent installation support script.\"",
          "    logger -t \"Failed to download the Deep Security Agent installation support script\"",
          "    exit 1",
          "fi",
          "platform_detect",
          "if [[ -z \"${linuxPlatform}\" ]] || [[ -z \"${isRPM}\" ]]; then",
          "    echo \"Unsupported platform is detected\"",
          "    logger -t \"Unsupported platform is detected\"",
          "    exit 1",
          "fi",
          "echo \"Downloading agent package...\"",
          "if [[ $isRPM == 1 ]]; then package=\"agent.rpm\"",
          "    else package=\"agent.deb\"",
          "fi",
          "curl -H \"Agent-Version-Control: on\" $MANAGERURL/software/agent/${runningPlatform}${majorVersion}/${archType}/$package?tenantID=52811 -o /tmp/$package $CURLOPTIONS",
          "echo \"Installing agent package...\"",
          "rc=1",
          "if [[ $isRPM == 1 && -s /tmp/agent.rpm ]]; then",
          "    rpm -ihv /tmp/agent.rpm",
          "    rc=$?",
          "elif [[ -s /tmp/agent.deb ]]; then",
          "    dpkg -i /tmp/agent.deb",
          "    rc=$?",
          "else",
          "    echo \"Failed to download the agent package.\"",
          "    logger -t \"Failed to download the agent package.\"",
          "    exit 1",
          "fi",
          "if [[ ${rc} != 0 ]]; then",
          "    echo \"Failed to install the agent package\"",
          "    logger -t \"Failed to install the agent package\"",
          "    exit 1",
          "fi",
          "echo \"Install the agent package successfully\"",
          "sleep 15",
          "echo \"Running Agent Registration\"",
          "/opt/ds_agent/dsa_control -r",
          "/opt/ds_agent/dsa_control -a $ACTIVATIONURL \"tenantID:0123456789-0123456789-0123456789\" \"token:0123456789-0123456789-0123456789\" \"policyid:123\""
        ]
      }
    },
    {
      "precondition": {
        "StringEquals": [
          "platformType",
          "Windows"
        ]
      },
      "action": "aws:runPowerShellScript",
      "name": "TrendMicroInstallandRegisterWindows",
      "onFailure": "Abort",
      "inputs": {
        "id": "0.aws:runPowerShellScript",
        "timeoutSeconds": 600,
        "runCommand": [
          "if (Get-Service \"ds_agent\" -ErrorAction SilentlyContinue)",
          "{",
          "  Write-Host \"Trend Cloud Agent is already installed, Exiting\"",
          "  exit 0",
          "}",
          "function New-TemporaryDirectory {",
          "  $parent = [System.IO.Path]::GetTempPath()",
          "  [string] $name = [System.Guid]::NewGuid()",
          "  New-Item -ItemType Directory -Path (Join-Path $parent $name)",
          "}",
          "$tempdir = New-TemporaryDirectory",
          "Write-Host \"TEMP DIR IS SET TO:\" $tempdir",
          "Set-Location -Path $tempdir",
          "Get-Location",
          "$managerUrl=\"https://app.deepsecurity.trendmicro.com:443/\"",
          "Start-Transcript -path \"$tempdir\\dsa_deploy.log\" -append",
          "echo \"$(Get-Date -format T) - DSA download started\"",
          "if ( [intptr]::Size -eq 8 ) { ",
          "   $sourceUrl=-join($managerUrl, \"software/agent/Windows/x86_64/agent.msi\") }",
          "else {",
          "   $sourceUrl=-join($managerUrl, \"software/agent/Windows/i386/agent.msi\") }",
          "echo \"$(Get-Date -format T) - Download Deep Security Agent Package\" $sourceUrl",
          "$ACTIVATIONURL=\"dsm://agents.deepsecurity.trendmicro.com:443/\"",
          "$WebClient = New-Object System.Net.WebClient",
          "#Add agent version control info",
          "$WebClient.Headers.Add(\"Agent-Version-Control\", \"on\")",
          "$WebClient.QueryString.Add(\"tenantID\", \"52811\")",
          "$WebClient.QueryString.Add(\"windowsVersion\", (Get-CimInstance Win32_OperatingSystem).Version)",
          "$WebClient.QueryString.Add(\"windowsProductType\", (Get-CimInstance Win32_OperatingSystem).ProductType)",
          "[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12;",
          "Try",
          "{",
          "    $WebClient.DownloadFile($sourceUrl,  \"$tempdir\\agent.msi\")",
          "} ",
          "Catch [System.Net.WebException]",
          "{",
          "    echo \" Please check that your Deep Security Manager TLS.\"",
          "    exit 2;",
          "}",
          "if ((Get-Item \"$tempdir\\agent.msi\").length -eq 0 ) {",
          "    echo \"Failed to download the Deep Security Agent\"",
          " exit 1",
          "}",
          "echo \"$(Get-Date -format T) - Downloaded File Size:\" (Get-Item \"$tempdir\\agent.msi\").length",
          "echo \"$(Get-Date -format T) - DSA install started\"",
          "echo \"$(Get-Date -format T) - Installer Exit Code:\" (Start-Process -FilePath msiexec -ArgumentList \"/i $tempdir\\agent.msi /qn ADDLOCAL=ALL /l*v `\"$tempdir\\dsa_install.log`\"\" -Wait -PassThru).ExitCode ",
          "echo \"$(Get-Date -format T) - DSA activation started\"",
          "Start-Sleep -s 50",
          "& $Env:ProgramFiles\"\\Trend Micro\\Deep Security Agent\\dsa_control\" -r",
          "& $Env:ProgramFiles\"\\Trend Micro\\Deep Security Agent\\dsa_control\" -a $ACTIVATIONURL \"tenantID:0123456789-0123456789-0123456789\" \"token:0123456789-0123456789-0123456789\" \"policyid:123\"",
          "Stop-Transcript",
          "echo \"$(Get-Date -format T) - DSA Deployment Finished\""
        ]
      }
    }
  ]
}